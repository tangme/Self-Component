function Ttag(t){var e=t.el;this.opt=t,this.pattern=this.opt.pattern||"&,&",this.editarea=document.querySelector(e),this.selectArea=this.editarea.querySelector(".t-tag-select-item-con"),this.inputForm=this.selectArea.querySelector("input"),this.tag={_show:!1},this.hideSelTag=this.hideSelTag.bind(this),this.onClose=this.opt.onClose||void 0,this.onTagClick=this.opt.onTagClick||void 0,this.onAdd=this.opt.onAdd||void 0,this.maxSize=this.opt.maxSize||0,this.init(),t.value&&this.setData(t.value),t.url&&this.ajax({url:t.url,onLoaded:t.onLoaded?t.onLoaded:null})}Ttag.prototype.ajax=function(t){var e=t.method,i=void 0===e?"post":e,a=t.url,n=t.data,o=t.onLoaded,r=t.flag,s=void 0===r||r,d=null,l=this;d=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHttp"),"GET"==i?(d.open(i,a+"?"+n,s),d.send()):"post"==i&&(d.open(i,a,s),d.setRequestHeader("Content-type","application/json"),d.send(n)),d.onreadystatechange=function(){4==d.readyState&&200==d.status&&o&&o(d.responseText,l)}},Ttag.prototype.setData=function(t){var e=t.split(",");for(var i in e)this.addTag(e[i],!1)},Ttag.prototype.init=function(){var i=this;Object.defineProperties(this.tag,{show:{get:function(){return this._show},set:function(t){var e=i.selectArea.getAttribute("class");t?(e=e.replace("close-ttag",""),document.addEventListener("click",i.hideSelTag)):(e=e.concat("close-ttag"),document.removeEventListener("click",i.hideSelTag)),i.selectArea.setAttribute("class",e),this._show=t}},size:{get:function(){return i.inputForm.value.split(i.pattern).filter(function(t){return!!t}).length}}}),this.editarea.addEventListener("click",function(t){if(t.stopPropagation(),t.preventDefault(),"edit-item-del-con"===t.target.getAttribute("class")){var e=t.target.parentNode.querySelector(".edit-item-text").innerHTML;return i.delFormData(e),void t.target.parentNode.parentNode.removeChild(t.target.parentNode)}if("edit-item-del"===t.target.getAttribute("class")){e=t.target.parentNode.parentNode.querySelector(".edit-item-text").innerHTML;return i.delFormData(e),void t.target.parentNode.parentNode.parentNode.removeChild(t.target.parentNode.parentNode)}"edit-item-text"!==t.target.getAttribute("class")?(i.tag.show||(i.tag.show=!0),"t-tag-con"===t.target.getAttribute("class")&&i.newTag()):i.onTagClick&&i.onTagClick(t.target.textContent)}),this.selectArea.addEventListener("click",function(t){t.stopPropagation(),"t-tag-item"===t.target.getAttribute("class")&&i.addTag(t.target.innerHTML)}),this.loadData()},Ttag.prototype.delFormData=function(t){t&&(this.inputForm.value=this.inputForm.value.replace(t+this.pattern,"")),this.onClose&&this.onClose(t)},Ttag.prototype.loadData=function(t){var i=this,e=this.opt.data&&this.opt.data.length?this.opt.data:[];if((e=t&&t.length?t:[]).length){var a=document.createDocumentFragment();e.forEach(function(t){t+i.pattern;var e=document.createElement("span");e.setAttribute("class","t-tag-item"),e.innerHTML=t,a.appendChild(e)}),this.selectArea.appendChild(a)}},Ttag.prototype.getFormData=function(t){return"string"===(t=t||"string")?this.inputForm.value:this.inputForm.value.split(this.pattern)},Ttag.prototype.addTag=function(t,e){if(!(this.maxSize&&this.tag.size>=this.maxSize||this.isDuplicate(t))){var i=document.createElement("li");i.setAttribute("class","edit-item");var a=document.createElement("span");a.setAttribute("class","edit-item-text"),a.innerHTML=t;var n=document.createElement("span");n.setAttribute("class","edit-item-del");var o=document.createElement("span");o.setAttribute("class","edit-item-del-con"),o.appendChild(n),i.appendChild(a),i.appendChild(o),this.editarea.appendChild(i),this.inputForm.value=this.inputForm.value+t+this.pattern,this.onAdd&&!1!==e&&this.onAdd(t,this.inputForm.value)}},Ttag.prototype.isDuplicate=function(t){for(var e=!1,i=this.inputForm.value.split(this.pattern),a=0,n=i.length;a<n;a++)if(i[a]===t){e=!0;break}return e},Ttag.prototype.hideSelTag=function(){console.log("选择框隐藏"),this.tag.show=!1},Ttag.prototype.newTag=function(){var a=this;if(!this.editarea.querySelector(".ttag-input")){var t=document.createElement("li");t.setAttribute("class","edit-item input-edit-item");var e=document.createElement("input");e.setAttribute("class","ttag-input"),t.appendChild(e),this.editarea.appendChild(t);var i=this.editarea.querySelector(".ttag-input");i.addEventListener("blur",function(){console.log("失去焦点"),this.value&&a.addTag(this.value),this.parentNode.parentNode.removeChild(this.parentNode),console.log("焦点移除")}),i.addEventListener("compositionstart",function(t){a.delFlag=!0}),i.addEventListener("compositionend",function(t){a.delFlag=!1}),i.addEventListener("keyup",function(t){13===t.keyCode&&(console.log("进入回车"),this.value&&(this.blur(),setTimeout(function(){console.log("回车重新聚焦"),a.editarea.click()})))}),i.addEventListener("keydown",function(t){if(8===t.keyCode){if(t.target.value.length||a.delFlag)return;var e=a.editarea.querySelectorAll(".edit-item:not(.input-edit-item)");if(console.log(e),e.length){var i=[].slice.call(e).pop();a.delFormData(i.firstElementChild.textContent),a.editarea.removeChild(i)}}}),i.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault()}),this.editarea.querySelector(".ttag-input").focus()}};